import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

import redirectUriFigure from '../../assets/next-auth-redirect-uri.png';
import ConfigureRedirectUri from '../../fragments/_configure-redirect-uri.mdx';
import GetAppSecret from '../../fragments/_get-app-secret.mdx';
import AssumingUrl from '../../fragments/_web-assuming-url.mdx';
import SignInFlowSummary from '../../fragments/_web-sign-in-flow-summary.mdx';

<SignInFlowSummary />

<AssumingUrl />

#### 로그인 리디렉션 URI 구성하기 \{#configure-sign-in-redirect-uri}

<ConfigureRedirectUri
  figureSrc={redirectUriFigure}
  redirectUri="http://localhost:3000/api/auth/callback/logto"
/>

#### Next Auth provider 설정하기 \{#set-up-next-auth-provider}

<GetAppSecret />

Next Auth의 API 경로 구성을 수정하세요. Pages Router를 사용하는 경우, 파일은 `pages/api/auth/[...nextauth].js`에 있으며, App Router를 사용하는 경우, 파일은 `app/api/auth/[...nextauth]/route.ts`에 있습니다.

다음은 App Router의 예시입니다:

<Tabs>

<TabItem value="v5" label="Next Auth v5">

```ts
import NextAuth from 'next-auth';

export const {
  handlers: { GET, POST },
  signIn,
  signOut,
  auth,
} = NextAuth({
  providers: [
    {
      id: 'logto',
      name: 'Logto',
      type: 'oidc',
      // Logto 애플리케이션 세부 정보 페이지에서 "발급자 (Issuer) 엔드포인트" 필드에서 발급자 값을 얻을 수 있습니다.
      issuer: 'https://xxxx.logto.app/oidc',
      clientId: '<logto-app-id>',
      clientSecret: '<logto-app-secret>',
      authorization: {
        params: { scope: 'openid offline_access profile email' },
      },
      profile(profile) {
        // 여기에서 사용자 프로필 매핑을 사용자 정의할 수 있습니다.
        return {
          id: profile.sub,
          name: profile.name ?? profile.username,
          email: profile.email,
          image: profile.picture,
        };
      },
    },
  ],
});
```

1. `issuer` URL을 Logto 애플리케이션의 "발급자 (Issuer) 엔드포인트"로 교체하세요.
2. `clientId`와 `clientSecret`을 Logto 애플리케이션의 ID와 비밀로 교체하세요.
3. 사용자 프로필을 Next Auth 사용자 객체에 매핑하기 위해 `profile` 함수를 사용자 정의하세요. 기본 매핑은 예시에서 보여줍니다.

</TabItem>

<TabItem value="v4" label="Next Auth v4">

```ts
import NextAuth from 'next-auth';

const handler = NextAuth({
  providers: [
    {
      id: 'logto',
      name: 'Logto',
      type: 'oauth',
      // Logto 애플리케이션 세부 정보 페이지에서 "OpenID Provider 구성 엔드포인트" 필드에서 잘 알려진 URL을 얻을 수 있습니다.
      wellKnown: 'https://xxxx.logto.app/oidc/.well-known/openid-configuration',
      authorization: { params: { scope: 'openid offline_access profile email' } },
      clientId: '<logto-app-id>',
      clientSecret: '<logto-app-secret>',
      client: {
        id_token_signed_response_alg: 'ES384',
      },
      profile(profile) {
        // 여기에서 사용자 프로필 매핑을 사용자 정의할 수 있습니다.
        return {
          id: profile.sub,
          name: profile.name ?? profile.username,
          email: profile.email,
          image: profile.picture,
        };
      },
    },
  ],
});

export { handler as GET, handler as POST };
```

1. `wellKnown` URL을 Logto 애플리케이션의 "OpenID Provider 구성 엔드포인트"로 교체하세요.
2. `clientId`와 `clientSecret`을 Logto 애플리케이션의 ID와 비밀로 교체하세요.
3. 사용자 프로필을 Next Auth 사용자 객체에 매핑하기 위해 `profile` 함수를 사용자 정의하세요. 기본 매핑은 예시에서 보여줍니다.
4. `id_token_signed_response_alg`를 `ES384`로 설정하는 것을 잊지 마세요.

</TabItem>

</Tabs>
